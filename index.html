<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Thumbnails v30 (Múltiplos Textos)</title>
    
    <!-- CSS e Fontes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&family=Anton&family=Bebas+Neue&family=Roboto:wght@700;900&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .preview-text-title, .preview-text-marketing { text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); }
        .preview-text-subtitle { text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7); }
        .draggable { position: absolute; cursor: move; border: 2px dashed transparent; transition: border-color 0.2s; }
        .draggable.selected { border-color: #06b6d4; }
        #preview-logo { display: none; }
        input[type="file"]::file-selector-button { @apply bg-cyan-500 text-slate-900 font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors hover:bg-cyan-400 border-0; }
        #preview-bg-image { transition: transform 0.2s ease-in-out, filter 0.2s ease-in-out; }

        .results-container img { cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 2px solid transparent; }
        .results-container img:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(56, 189, 248, 0.7); border-color: #06b6d4; }
        .loader { width: 24px; height: 24px; border: 3px solid #FFF; border-bottom-color: transparent; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #thumbnail-preview.aspect-video { aspect-ratio: 16 / 9; }
        #thumbnail-preview.aspect-square { aspect-ratio: 1 / 1; }
        #thumbnail-preview.aspect-portrait { aspect-ratio: 9 / 16; }

        #alignment-grid { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); pointer-events: none; z-index: 99; }
        #alignment-grid.hidden { display: none; }
        #alignment-grid > div { border: 1px solid rgba(255, 255, 255, 0.4); }

        .text-gradient { background-clip: text; -webkit-background-clip: text; color: transparent !important; }
        
        .accordion-legend { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; width: 100%; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; padding: 0 1rem; }
        .accordion-fieldset.open > .accordion-content { max-height: 1000px; padding: 1rem; transition: max-height 0.5s ease-in, padding 0.5s ease-in; }
        .accordion-icon { transition: transform 0.3s ease-in-out; }
        .accordion-fieldset.open .accordion-icon { transform: rotate(180deg); }

        .graphic-element { position: absolute; border: 2px dashed transparent; transition: border-color 0.2s; }
        .graphic-element.selected { border-color: #06b6d4; }
        .resizer { position: absolute; width: 10px; height: 10px; background: #06b6d4; border: 1px solid white; border-radius: 50%; display: none; }
        .graphic-element.selected .resizer { display: block; }
        .resizer.bottom-right { bottom: -5px; right: -5px; cursor: se-resize; }
        .delete-btn { position: absolute; top: -10px; right: -10px; width: 22px; height: 22px; background: #ef4444; color: white; border-radius: 50%; border: 2px solid white; cursor: pointer; display: none; justify-content: center; align-items: center; font-size: 14px; font-weight: bold; line-height: 1; box-shadow: 0 2px 5px rgba(0,0,0,0.4); }
        .graphic-element.selected .delete-btn { display: flex; }
        
        #font-results-container .font-item { cursor: pointer; padding: 0.5rem; border-radius: 0.375rem; }
        #font-results-container .font-item:hover { background-color: rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="bg-slate-900 text-white antialiased">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-cyan-400" style="font-family: 'Bebas Neue', cursive;">Gerador de Thumbnails</h1>
            <p class="text-slate-400 mt-2">Crie capas profissionais para seus beats em segundos.</p>
        </header>

        <main class="flex flex-col gap-8">
            <!-- Painel de Controles -->
            <div id="controls-panel" class="w-full bg-slate-800 p-6 rounded-2xl shadow-lg border border-slate-700">
                <h2 class="text-2xl font-bold mb-4 border-b border-slate-600 pb-4 text-center">Personalize sua Capa</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Coluna 1 -->
                    <div class="md:col-span-1 space-y-2">
                        <fieldset class="accordion-fieldset border border-slate-600 rounded-lg open">
                            <legend class="accordion-legend px-2 text-cyan-400 font-bold"><span>Presets</span><svg class="accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></legend>
                            <div class="accordion-content space-y-4">
                                <div class="space-y-2">
                                    <label for="preset-name-input" class="text-sm font-medium text-slate-300">Nome do Novo Preset</label>
                                    <input type="text" id="preset-name-input" placeholder="Ex: Meu Preset Lofi" class="w-full bg-slate-700 border-slate-600 rounded-lg p-2.5">
                                    <button id="save-preset-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 rounded-lg">Salvar Preset</button>
                                </div>
                                <div class="border-t border-slate-700 pt-4 space-y-2">
                                     <label for="load-preset-select" class="text-sm font-medium text-slate-300">Carregar Preset</label>
                                     <select id="load-preset-select" class="w-full bg-slate-700 border-slate-600 rounded-lg p-2.5 mb-2"></select>
                                     <div class="flex gap-2">
                                         <button id="load-preset-btn" class="w-1/2 bg-green-600 hover:bg-green-500 text-white font-semibold py-2 rounded-lg">Carregar</button>
                                         <button id="delete-preset-btn" class="w-1/2 bg-red-600 hover:bg-red-500 text-white font-semibold py-2 rounded-lg">Excluir</button>
                                     </div>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="accordion-fieldset border border-slate-600 rounded-lg">
                            <legend class="accordion-legend px-2 text-cyan-400 font-bold"><span>Formato</span><svg class="accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></legend>
                            <div class="accordion-content"><div id="format-selector" class="grid grid-cols-3 gap-2"><button data-format="video" class="format-btn bg-cyan-600 text-white font-semibold py-2 rounded-lg">16:9</button><button data-format="square" class="format-btn bg-slate-700 text-slate-300 font-semibold py-2 rounded-lg">1:1</button><button data-format="portrait" class="format-btn bg-slate-700 text-slate-300 font-semibold py-2 rounded-lg">9:16</button></div></div>
                        </fieldset>
                        <fieldset class="accordion-fieldset border border-slate-600 rounded-lg">
                            <legend class="accordion-legend px-2 text-cyan-400 font-bold"><span>Layout</span><svg class="accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></legend>
                            <div class="accordion-content"><select id="template-select" class="w-full bg-slate-700 border-slate-600 rounded-lg p-2.5"><option value="center">Centralizado</option><option value="align-left">Esquerda</option><option value="align-right">Direita</option><option value="bottom-left">Inferior Esquerdo</option><option value="vertical-left">Vertical Esquerda</option><option value="big-title">Título Grande</option></select></div>
                        </fieldset>
                         <fieldset class="accordion-fieldset border border-slate-600 rounded-lg">
                             <legend class="accordion-legend px-2 text-cyan-400 font-bold"><span>Imagens e Logo</span><svg class="accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></legend>
                             <div class="accordion-content space-y-4">
                                <div><label for="image-search-input" class="block mb-2 text-sm font-medium text-slate-300">Buscar Fundo (Unsplash)</label><div class="flex gap-2"><input type="text" id="image-search-input" placeholder="Ex: 'dark city'..." class="w-full bg-slate-700 border-slate-600 rounded-lg p-2.5"><button id="image-search-btn" class="bg-cyan-600 hover:bg-cyan-500 text-slate-100 font-bold py-2 px-4 rounded-lg flex items-center justify-center w-24">Buscar</button></div></div>
                                <div id="image-results-container" class="results-container grid grid-cols-3 gap-2 h-40 overflow-y-auto bg-slate-900/50 rounded-lg p-2 border border-slate-700"></div>
                                <div><label for="background-upload" class="block mb-2 text-sm font-medium text-slate-300">Ou Enviar Fundo do PC</label><input type="file" id="background-upload" accept="image/*" class="w-full text-sm text-slate-400 file:mr-4 file:border-0"></div>
                                <div class="border-t border-slate-700 pt-4 space-y-2"><label for="logo-upload" class="block text-sm font-medium text-slate-300">Enviar Logo</label><input type="file" id="logo-upload" accept="image/*" class="w-full text-sm text-slate-400 file:mr-4 file:border-0"><label for="logo-size" class="block text-sm text-slate-300">Tamanho da Logo: <span id="logo-size-value">100px</span></label><input type="range" id="logo-size" min="20" max="500" step="5" value="100" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer"></div>
                            </div>
                        </fieldset>
                         <fieldset class="accordion-fieldset border border-slate-600 rounded-lg">
                            <legend class="accordion-legend px-2 text-cyan-400 font-bold"><span>Stickers</span><svg class="accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></legend>
                            <div class="accordion-content space-y-4">
                                <div><label for="sticker-search-input" class="block mb-2 text-sm font-medium text-slate-300">Buscar Stickers (Pixabay)</label><div class="flex gap-2"><input type="text" id="sticker-search-input" placeholder="Ex: 'arrow', 'fire'..." class="w-full bg-slate-700 border-slate-600 rounded-lg p-2.5"><button id="sticker-search-btn" class="bg-purple-600 hover:bg-purple-500 text-slate-100 font-bold py-2 px-4 rounded-lg flex items-center justify-center w-24">Buscar</button></div></div>
                                <div id="sticker-results-container" class="results-container grid grid-cols-3 gap-2 h-40 overflow-y-auto bg-slate-900/50 rounded-lg p-2 border border-slate-700"></div>
                                <div class="border-t border-slate-700 pt-4"><label for="sticker-upload" class="block mb-2 text-sm font-medium text-slate-300">Ou Enviar Sticker do PC</label><input type="file" id="sticker-upload" accept="image/*" class="w-full text-sm text-slate-400 file:mr-4 file:border-0"></div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Coluna 2 -->
                     <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-2">
                        <fieldset class="accordion-fieldset border border-slate-600 rounded-lg">
                            <legend class="accordion-legend px-2 text-cyan-400 font-bold"><span>Título</span><svg class="accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></legend>
                            <div class="accordion-content space-y-4">
                                <input type="text" id="beat-title" value="NIGHT DRIVE" class="w-full bg-slate-700 border rounded-lg p-2.5">
                                <div class="space-y-2">
                                    <label for="font-search-input" class="text-sm font-medium text-slate-300">Fonte (Google Fonts)</label>
                                    <input type="text" id="font-search-input" placeholder="Buscar por nome da fonte..." class="w-full bg-slate-700 border-slate-600 rounded-lg p-2.5">
                                    <div id="font-results-container" class="results-container h-40 overflow-y-auto bg-slate-900/50 rounded-lg p-2 border border-slate-700"></div>
                                </div>
                                <label>Tamanho: <span id="title-size-value">80px</span><input type="range" id="title-size" min="30" max="150" value="80" class="w-full h-2 mt-1 bg-slate-700 rounded-lg"></label>
                                <div class="border-t border-slate-700 pt-4 space-y-4"><h4 class="text-sm font-bold text-slate-300">Efeitos de Texto</h4><label>Preenchimento<select id="title-fill-type" class="w-full bg-slate-700 p-2.5 rounded-lg mt-1"><option value="solid">Cor Sólida</option><option value="gradient">Gradiente</option></select></label><div id="title-solid-color-controls"><label>Cor Sólida<input type="color" id="title-color-solid" value="#FFFFFF" class="w-full h-10 p-1 mt-1 bg-slate-700 rounded-lg"></label></div><div id="title-gradient-controls" class="hidden space-y-3"><div class="flex gap-4"><label class="w-1/2">Cor 1<input type="color" id="title-color-1" value="#FFFFFF" class="w-full h-10 p-1 mt-1 bg-slate-700 rounded-lg"></label><label class="w-1/2">Cor 2<input type="color" id="title-color-2" value="#22D3EE" class="w-full h-10 p-1 mt-1 bg-slate-700 rounded-lg"></label></div><label class="block">Ângulo: <span id="title-gradient-angle-value">90deg</span><input type="range" id="title-gradient-angle" min="0" max="360" value="90" class="w-full h-2 mt-1 bg-slate-700 rounded-lg"></label></div><div class="border-t border-slate-700 pt-4 space-y-2"><label>Contorno<input type="color" id="title-stroke-color" value="#000000" class="w-full h-10 p-1 mt-1 bg-slate-700 rounded-lg"></label><label>Espessura: <span id="title-stroke-width-value">0.0px</span><input type="range" id="title-stroke-width" min="0" max="2" step="0.1" value="0" class="w-full h-2 mt-1 bg-slate-700 rounded-lg"></label></div></div>
                            </div>
                        </fieldset>
                        <fieldset class="accordion-fieldset border border-slate-600 rounded-lg">
                            <legend class="accordion-legend px-2 text-cyan-400 font-bold"><span>Textos Auxiliares</span><svg class="accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></legend>
                            <div class="accordion-content space-y-3">
                                <input type="text" id="producer-name" placeholder="Nome do Produtor / Artista" value="Travis Scott x Migos Type Beat" class="w-full bg-slate-700 border rounded-lg p-2.5">
                                <input type="text" id="genre-tag" placeholder="Gênero" value="Trap | Phonk" class="w-full bg-slate-700 border rounded-lg p-2.5">
                                <div class="flex gap-2"><input type="text" id="bpm-input" placeholder="BPM" value="140 BPM" class="w-1/2 bg-slate-700 rounded-lg p-2.5"><input type="text" id="key-input" placeholder="Tom" value="C#m" class="w-1/2 bg-slate-700 rounded-lg p-2.5"></div>
                                <div class="border-t border-slate-700 pt-3 space-y-3"><label>Cor: <input type="color" id="aux-text-color" value="#FFFFFF" class="w-full h-10 p-1 mt-1 bg-slate-700 rounded-lg"></label><label>Tamanho: <span id="aux-text-size-value">18px</span><input type="range" id="aux-text-size" min="10" max="50" value="18" class="w-full h-2 mt-1 bg-slate-700 rounded-lg"></label></div>
                            </div>
                        </fieldset>
                        <!-- PAINEL DE TEXTOS ADICIONAIS -->
                        <fieldset class="accordion-fieldset border border-slate-600 rounded-lg">
                            <legend class="accordion-legend px-2 text-cyan-400 font-bold"><span>Textos Adicionais</span><svg class="accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></legend>
                            <div class="accordion-content space-y-3">
                                <button id="add-text-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 rounded-lg">Adicionar Novo Texto</button>
                                <div id="additional-text-editor" class="hidden space-y-3 border-t border-slate-700 pt-3">
                                    <h4 class="text-sm font-bold text-slate-300">Editando Texto Selecionado</h4>
                                    <input type="text" id="additional-text-input" class="w-full bg-slate-900 border rounded-lg p-2.5">
                                    <button id="generate-phrase-btn" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-semibold py-2 rounded-lg text-sm flex items-center justify-center gap-2">Gerar Frase com IA</button>
                                    <label>Cor: <input type="color" id="additional-text-color" value="#FFFFFF" class="w-full h-10 p-1 mt-1 bg-slate-900 rounded-lg"></label>
                                    <label>Tamanho: <span id="additional-text-size-value">24px</span><input type="range" id="additional-text-size" min="10" max="100" value="24" class="w-full h-2 mt-1 bg-slate-900 rounded-lg"></label>
                                    <button id="delete-text-btn" class="w-full bg-red-600 hover:bg-red-500 text-white font-semibold py-2 rounded-lg">Excluir Texto</button>
                                </div>
                            </div>
                        </fieldset>
                        <fieldset class="accordion-fieldset border border-slate-600 rounded-lg">
                            <legend class="accordion-legend px-2 text-cyan-400 font-bold"><span>Overlay</span><svg class="accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></legend>
                            <div class="accordion-content space-y-4">
                                <select id="overlay-type" class="w-full bg-slate-700 p-2.5 rounded-lg"><option value="solid">Cor Sólida</option><option value="gradient">Gradiente</option></select>
                                <div id="solid-color-controls"><label class="block text-sm">Cor</label><input title="Cor Sólida" type="color" id="overlay-color-solid" value="#000000" class="w-full h-10 p-1 bg-slate-700 border border-slate-600 rounded-lg cursor-pointer"></div>
                                <div id="gradient-controls" class="hidden space-y-3"><div class="flex gap-4"><label class="w-1/2">Cor 1<input type="color" id="overlay-color-1" value="#000000" class="w-full h-10 p-1 mt-1 bg-slate-700 rounded-lg"></label><label class="w-1/2">Cor 2<input type="color" id="overlay-color-2" value="#4338ca" class="w-full h-10 p-1 mt-1 bg-slate-700 rounded-lg"></label></div><label class="block">Ângulo: <span id="gradient-angle-value">90deg</span><input type="range" id="gradient-angle" min="0" max="360" value="90" class="w-full h-2 mt-1 bg-slate-700 rounded-lg"></label></div>
                                <div><label class="block">Opacidade: <span id="opacity-value">50%</span></label><input type="range" id="overlay-opacity" min="0" max="1" step="0.05" value="0.5" class="w-full h-2 bg-slate-700 rounded-lg cursor-pointer"></div>
                            </div>
                        </fieldset>
                        <fieldset class="accordion-fieldset border border-slate-600 rounded-lg">
                            <legend class="accordion-legend px-2 text-cyan-400 font-bold"><span>Filtros</span><svg class="accordion-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></legend>
                            <div class="accordion-content space-y-3">
                                <label>Desfoque: <span id="blur-value">0px</span><input type="range" id="filter-blur" min="0" max="20" value="0" step="1" class="w-full h-2 bg-slate-700 rounded-lg"></label>
                                <label>Contraste: <span id="contrast-value">100%</span><input type="range" id="filter-contrast" min="0" max="200" value="100" class="w-full h-2 bg-slate-700 rounded-lg"></label>
                                <label>Saturação: <span id="saturation-value">100%</span><input type="range" id="filter-saturation" min="0" max="200" value="100" class="w-full h-2 bg-slate-700 rounded-lg"></label>
                                <label>Preto e Branco: <span id="grayscale-value">0%</span><input type="range" id="filter-grayscale" min="0" max="100" value="0" class="w-full h-2 bg-slate-700 rounded-lg"></label>
                            </div>
                        </fieldset>
                    </div>
                </div>
            </div>

            <!-- Área de Pré-visualização -->
            <div class="w-full flex flex-col items-center justify-center">
                 <div class="w-full max-w-5xl flex justify-end mb-2">
                    <button id="grid-toggle-btn" class="bg-slate-700 hover:bg-slate-600 text-slate-300 font-semibold py-2 px-4 rounded-lg text-sm">Mostrar Grade</button>
                </div>
                <div id="preview-container-wrapper" class="transition-all duration-300 w-full">
                    <div id="thumbnail-preview" class="bg-black rounded-2xl shadow-2xl overflow-hidden relative mx-auto">
                        <div id="alignment-grid" class="hidden">
                           <div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div>
                        </div>
                        <img id="preview-bg-image" src="https://placehold.co/1280x720/1a1b26/ffffff?text=Sua+Arte+Aqui" crossorigin="anonymous" class="absolute top-0 left-0 w-full h-full object-cover" alt="Background">
                        <div id="preview-overlay" class="absolute top-0 left-0 w-full h-full"></div>
                        <img id="preview-logo" alt="Sua logo" class="draggable">
                        <div id="genre-wrapper" class="draggable"><h3 id="preview-genre" class="font-bold uppercase tracking-widest preview-text-subtitle text-center"></h3></div>
                        <div id="title-wrapper" class="draggable"><h1 id="preview-title" class="font-black uppercase break-words preview-text-title leading-none text-center"></h1></div>
                        <div id="producer-wrapper" class="draggable"><p id="preview-producer" class="tracking-wider preview-text-subtitle text-center"></p></div>
                        <div id="bpm-key-wrapper" class="draggable"><div id="preview-bpm-key" class="font-semibold tracking-wider preview-text-subtitle text-center"></div></div>
                    </div>
                </div>
                <button id="download-btn" class="mt-8 bg-cyan-500 hover:bg-cyan-400 text-slate-900 font-bold py-3 px-8 rounded-lg shadow-lg">Gerar & Baixar PNG</button>
            </div>
        </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const UNSPLASH_API_KEY = 'tb7jsDOnpD4MF2lqra9u9eDU7PqN6AHZvMnMJP1I1Rg';
            const PIXABAY_API_KEY = '51104270-3423bedd95b75390c92ed30fa';
            const GOOGLE_FONTS_API_KEY = 'AIzaSyAXRkBCEpNA_fOIbOoIFmwQCRGni9by-mw';
            const PRESETS_STORAGE_KEY = 'thumbnailGeneratorPresets';
            let zIndexCounter = 50; 
            let googleFonts = [];
            const GEMINI_API_KEY = "";
            let selectedAdditionalText = null;

            const dom = {
                controls: {
                    beatTitle: document.getElementById('beat-title'), producerName: document.getElementById('producer-name'),
                    genreTag: document.getElementById('genre-tag'), bpm: document.getElementById('bpm-input'),
                    key: document.getElementById('key-input'), backgroundUpload: document.getElementById('background-upload'),
                    logoUpload: document.getElementById('logo-upload'), logoSize: document.getElementById('logo-size'),
                    fontSearchInput: document.getElementById('font-search-input'), fontResultsContainer: document.getElementById('font-results-container'),
                    titleSize: document.getElementById('title-size'),
                    templateSelect: document.getElementById('template-select'), downloadBtn: document.getElementById('download-btn'),
                    imageSearchInput: document.getElementById('image-search-input'), imageSearchBtn: document.getElementById('image-search-btn'),
                    imageResultsContainer: document.getElementById('image-results-container'), formatSelector: document.getElementById('format-selector'),
                    overlayType: document.getElementById('overlay-type'), solidColorControls: document.getElementById('solid-color-controls'),
                    gradientControls: document.getElementById('gradient-controls'), overlayColorSolid: document.getElementById('overlay-color-solid'),
                    overlayColor1: document.getElementById('overlay-color-1'), overlayColor2: document.getElementById('overlay-color-2'),
                    gradientAngle: document.getElementById('gradient-angle'), overlayOpacity: document.getElementById('overlay-opacity'),
                    filterBlur: document.getElementById('filter-blur'), filterContrast: document.getElementById('filter-contrast'),
                    filterSaturation: document.getElementById('filter-saturation'), filterGrayscale: document.getElementById('filter-grayscale'),
                    gridToggleBtn: document.getElementById('grid-toggle-btn'),
                    titleFillType: document.getElementById('title-fill-type'),
                    titleSolidColorControls: document.getElementById('title-solid-color-controls'),
                    titleGradientControls: document.getElementById('title-gradient-controls'),
                    titleColorSolid: document.getElementById('title-color-solid'),
                    titleColor1: document.getElementById('title-color-1'),
                    titleColor2: document.getElementById('title-color-2'),
                    titleGradientAngle: document.getElementById('title-gradient-angle'),
                    titleStrokeColor: document.getElementById('title-stroke-color'),
                    titleStrokeWidth: document.getElementById('title-stroke-width'),
                    auxTextColor: document.getElementById('aux-text-color'),
                    auxTextSize: document.getElementById('aux-text-size'),
                    controlsPanel: document.getElementById('controls-panel'),
                    stickerSearchInput: document.getElementById('sticker-search-input'),
                    stickerSearchBtn: document.getElementById('sticker-search-btn'),
                    stickerResultsContainer: document.getElementById('sticker-results-container'),
                    stickerUpload: document.getElementById('sticker-upload'),
                    presetNameInput: document.getElementById('preset-name-input'),
                    savePresetBtn: document.getElementById('save-preset-btn'),
                    loadPresetSelect: document.getElementById('load-preset-select'),
                    loadPresetBtn: document.getElementById('load-preset-btn'),
                    deletePresetBtn: document.getElementById('delete-preset-btn'),
                    addTextBtn: document.getElementById('add-text-btn'),
                    additionalTextEditor: document.getElementById('additional-text-editor'),
                    additionalTextInput: document.getElementById('additional-text-input'),
                    generatePhraseBtn: document.getElementById('generate-phrase-btn'),
                    additionalTextColor: document.getElementById('additional-text-color'),
                    additionalTextSize: document.getElementById('additional-text-size'),
                    deleteTextBtn: document.getElementById('delete-text-btn'),
                },
                preview: {
                    title: document.getElementById('preview-title'), producer: document.getElementById('preview-producer'),
                    genre: document.getElementById('preview-genre'), bpmKey: document.getElementById('preview-bpm-key'),
                    bgImage: document.getElementById('preview-bg-image'), overlay: document.getElementById('preview-overlay'),
                    logo: document.getElementById('preview-logo'), container: document.getElementById('thumbnail-preview'),
                    containerWrapper: document.getElementById('preview-container-wrapper'), alignmentGrid: document.getElementById('alignment-grid'),
                    wrappers: { 
                        title: document.getElementById('title-wrapper'), 
                        producer: document.getElementById('producer-wrapper'), 
                        genre: document.getElementById('genre-wrapper'), 
                        bpmKey: document.getElementById('bpm-key-wrapper'),
                    }
                },
                valueDisplays: {
                    logoSize: document.getElementById('logo-size-value'), titleSize: document.getElementById('title-size-value'),
                    opacity: document.getElementById('opacity-value'), gradientAngle: document.getElementById('gradient-angle-value'),
                    blur: document.getElementById('blur-value'), contrast: document.getElementById('contrast-value'),
                    saturation: document.getElementById('saturation-value'), grayscale: document.getElementById('grayscale-value'),
                    titleStrokeWidth: document.getElementById('title-stroke-width-value'),
                    titleGradientAngle: document.getElementById('title-gradient-angle-value'),
                    auxTextSize: document.getElementById('aux-text-size-value'),
                    additionalTextSize: document.getElementById('additional-text-size-value'),
                }
            };
            
            const TEMPLATES = { center: { title: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }, producer: { top: '65%', left: '50%', transform: 'translateX(-50%)' }, genre: { top: '35%', left: '50%', transform: 'translateX(-50%)' }, bpmKey: { top: '88%', left: '50%', transform: 'translateX(-50%)' } }, 'align-left': { title: { top: '38%', left: '8%', transform: 'none' }, producer: { top: '52%', left: '8%', transform: 'none' }, genre: { top: '30%', left: '8%', transform: 'none' }, bpmKey: { top: '88%', left: '8%', transform: 'none' } }, 'align-right': { title: { top: '38%', left: '92%', transform: 'translateX(-100%)' }, producer: { top: '52%', left: '92%', transform: 'translateX(-100%)' }, genre: { top: '30%', left: '92%', transform: 'translateX(-100%)' }, bpmKey: { top: '88%', left: '92%', transform: 'translateX(-100%)' } }, 'bottom-left': { genre: { top: '65%', left: '8%', transform: 'none' }, title: { top: '70%', left: '8%', transform: 'none' }, producer: { top: '85%', left: '8%', transform: 'none' }, bpmKey: { top: '90%', left: '8%', transform: 'none' } }, 'vertical-left': { genre: { top: '25%', left: '8%', transform: 'none' }, title: { top: '35%', left: '8%', transform: 'none' }, producer: { top: '55%', left: '8%', transform: 'none' }, bpmKey: { top: '65%', left: '8%', transform: 'none' } }, 'big-title': { title: { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }, genre: { top: '10%', left: '50%', transform: 'translateX(-50%)' }, producer: { top: '80%', left: '50%', transform: 'translateX(-50%)' }, bpmKey: { top: '90%', left: '50%', transform: 'translateX(-50%)' } }, };
            
            const bringToFront = (element) => {
                zIndexCounter++;
                element.style.zIndex = zIndexCounter;
                document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
            };

            const updatePreview = () => {
                const { controls, preview, valueDisplays } = dom;
                preview.title.innerText = controls.beatTitle.value;
                preview.producer.innerText = controls.producerName.value;
                preview.genre.innerText = controls.genreTag.value;
                preview.bpmKey.innerHTML = `<span>${controls.bpm.value}</span> &bull; <span>${controls.key.value}</span>`;
                const auxColor = controls.auxTextColor.value;
                const auxSize = controls.auxTextSize.value;
                [preview.producer, preview.genre, preview.bpmKey].forEach(el => {
                    el.style.color = auxColor;
                    el.style.fontSize = `${auxSize}px`;
                });
                valueDisplays.auxTextSize.textContent = `${auxSize}px`;
                preview.title.style.fontSize = `${controls.titleSize.value}px`;
                valueDisplays.titleSize.textContent = `${controls.titleSize.value}px`;
                preview.logo.style.width = `${controls.logoSize.value}px`;
                valueDisplays.logoSize.textContent = `${controls.logoSize.value}px`;

                const title = preview.title;
                if (controls.titleFillType.value === 'solid') {
                    title.classList.remove('text-gradient');
                    title.style.color = controls.titleColorSolid.value;
                    title.style.backgroundImage = 'none';
                } else {
                    title.classList.add('text-gradient');
                    const angle = controls.titleGradientAngle.value;
                    const c1 = controls.titleColor1.value;
                    const c2 = controls.titleColor2.value;
                    title.style.backgroundImage = `linear-gradient(${angle}deg, ${c1}, ${c2})`;
                    valueDisplays.titleGradientAngle.textContent = `${angle}deg`;
                }
                const strokeWidth = controls.titleStrokeWidth.value;
                title.style.webkitTextStroke = `${strokeWidth}px ${controls.titleStrokeColor.value}`;
                valueDisplays.titleStrokeWidth.textContent = `${Number(strokeWidth).toFixed(1)}px`;
                preview.overlay.style.opacity = controls.overlayOpacity.value;
                valueDisplays.opacity.textContent = `${Math.round(controls.overlayOpacity.value * 100)}%`;
                if (controls.overlayType.value === 'solid') {
                    preview.overlay.style.backgroundColor = controls.overlayColorSolid.value;
                    preview.overlay.style.backgroundImage = 'none';
                } else {
                    const angle = controls.gradientAngle.value;
                    preview.overlay.style.backgroundImage = `linear-gradient(${angle}deg, ${controls.overlayColor1.value}, ${controls.overlayColor2.value})`;
                    preview.overlay.style.backgroundColor = 'transparent';
                    valueDisplays.gradientAngle.textContent = `${angle}deg`;
                }
                const blur = controls.filterBlur.value;
                const contrast = controls.filterContrast.value;
                const saturation = controls.filterSaturation.value;
                const grayscale = controls.filterGrayscale.value;
                preview.bgImage.style.filter = `blur(${blur}px) contrast(${contrast}%) saturate(${saturation}%) grayscale(${grayscale}%)`;
                valueDisplays.blur.textContent = `${blur}px`;
                valueDisplays.contrast.textContent = `${contrast}%`;
                valueDisplays.saturation.textContent = `${saturation}%`;
                valueDisplays.grayscale.textContent = `${grayscale}%`;
            };

            const applyTemplate = (templateName) => {
                const template = TEMPLATES[templateName];
                if (!template) return;
                Object.keys(template).forEach(key => {
                    const wrapper = dom.preview.wrappers[key];
                    if (wrapper) Object.assign(wrapper.style, template[key]);
                });
                updatePreview();
            };
            
            const makeDraggableAndResizable = (element) => {
                 element.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('resizer') || e.target.classList.contains('delete-btn')) return;
                    bringToFront(element);
                    
                    if (element.classList.contains('additional-text-wrapper')) {
                        showTextEditorFor(element);
                    } else {
                        hideTextEditor();
                    }

                    let isDragging = true;
                    const cRect = dom.preview.container.getBoundingClientRect();
                    const elRect = element.getBoundingClientRect();
                    const offsetX = e.clientX - elRect.left;
                    const offsetY = e.clientY - elRect.top;
                    document.onmousemove = (moveEvent) => {
                        if (!isDragging) return;
                        let newX = moveEvent.clientX - cRect.left - offsetX;
                        let newY = moveEvent.clientY - cRect.top - offsetY;
                        newX = Math.max(0, Math.min(newX, cRect.width - element.offsetWidth));
                        newY = Math.max(0, Math.min(newY, cRect.height - element.offsetHeight));
                        element.style.left = `${newX}px`;
                        element.style.top = `${newY}px`;
                        element.style.transform = 'none';
                    };
                    document.onmouseup = () => { isDragging = false; document.onmousemove = null; document.onmouseup = null; };
                    e.stopPropagation();
                });
                const resizer = element.querySelector('.resizer');
                if (resizer) {
                    resizer.onmousedown = (e) => {
                        e.preventDefault(); e.stopPropagation();
                        let isResizing = true;
                        const startX = e.clientX;
                        const startY = e.clientY;
                        const startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
                        document.onmousemove = (moveEvent) => {
                            if (!isResizing) return;
                            const newWidth = startWidth + (moveEvent.clientX - startX);
                            element.style.width = `${newWidth}px`;
                            element.style.height = 'auto';
                        };
                        document.onmouseup = () => { isResizing = false; document.onmousemove = null; document.onmouseup = null; };
                    };
                }
            };
            
            const handleDownload = () => {
                document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                const btn = dom.controls.downloadBtn;
                btn.textContent = 'Gerando...'; btn.disabled = true;
                const isGridHidden = dom.preview.alignmentGrid.classList.contains('hidden');
                dom.preview.alignmentGrid.classList.add('hidden');
                
                html2canvas(dom.preview.container, { useCORS: true, allowTaint: true, scale: 2, backgroundColor: null, width: dom.preview.container.scrollWidth, height: dom.preview.container.scrollHeight }).then(canvas => { 
                    const link = document.createElement('a'); 
                    link.download = `${dom.controls.beatTitle.value.toLowerCase().replace(/\s+/g, '-')}-thumbnail.png`; 
                    link.href = canvas.toDataURL('image/png'); 
                    link.click(); 
                }).catch(err => { 
                    console.error('Oops! Algo deu errado:', err); 
                }).finally(() => {
                    btn.textContent = 'Gerar & Baixar PNG'; 
                    btn.disabled = false;
                    if (!isGridHidden) dom.preview.alignmentGrid.classList.remove('hidden');
                });
            };

            const handleImageSearch = async () => {
                const query = dom.controls.imageSearchInput.value; if (!query) return;
                const searchBtn = dom.controls.imageSearchBtn; const resultsContainer = dom.controls.imageResultsContainer;
                searchBtn.innerHTML = '<span class="loader"></span>'; searchBtn.disabled = true; resultsContainer.innerHTML = '';
                try {
                    const response = await fetch(`https://api.unsplash.com/search/photos?query=${encodeURIComponent(query)}&per_page=12&client_id=${UNSPLASH_API_KEY}`);
                    if (!response.ok) { throw new Error(`Erro na API: ${response.statusText}`); }
                    const data = await response.json();
                    if (data.results.length === 0) { resultsContainer.innerHTML = `<p class="text-slate-400 p-2 text-center col-span-3">Nenhuma imagem encontrada.</p>`; }
                    else { data.results.forEach(photo => { const img = document.createElement('img'); img.src = photo.urls.thumb; img.alt = photo.alt_description; img.dataset.fullUrl = photo.urls.regular; img.className = 'w-full h-full object-cover rounded-md'; img.addEventListener('click', () => {
                        dom.preview.bgImage.crossOrigin = "anonymous";
                        dom.preview.bgImage.src = img.dataset.fullUrl; 
                    }); resultsContainer.appendChild(img); }); }
                } catch (error) { console.error("Erro ao buscar imagens:", error); resultsContainer.innerHTML = `<p class="text-red-400 p-2 text-center col-span-3">Falha ao buscar.</p>`;
                } finally { searchBtn.innerHTML = 'Buscar'; searchBtn.disabled = false; }
            };

             const handleStickerSearch = async () => {
                const query = dom.controls.stickerSearchInput.value; if (!query) return;
                const searchBtn = dom.controls.stickerSearchBtn; const resultsContainer = dom.controls.stickerResultsContainer;
                searchBtn.innerHTML = '<span class="loader"></span>'; searchBtn.disabled = true; resultsContainer.innerHTML = '';
                try {
                    const response = await fetch(`https://pixabay.com/api/?key=${PIXABAY_API_KEY}&q=${encodeURIComponent(query)}&image_type=illustration&per_page=12`);
                    if (!response.ok) { throw new Error(`Erro na API: ${response.statusText}`); }
                    const data = await response.json();
                    if (data.hits.length === 0) { resultsContainer.innerHTML = `<p class="text-slate-400 p-2 text-center col-span-3">Nenhum sticker encontrado.</p>`; }
                    else { data.hits.forEach(hit => {
                        const img = document.createElement('img');
                        img.src = hit.previewURL;
                        img.dataset.fullUrl = hit.webformatURL;
                        img.alt = hit.tags;
                        img.className = 'w-full h-full object-contain rounded-md bg-white/10';
                        img.addEventListener('click', () => addGraphic(img.dataset.fullUrl));
                        resultsContainer.appendChild(img); 
                    }); }
                } catch (error) { console.error("Erro ao buscar stickers:", error); resultsContainer.innerHTML = `<p class="text-red-400 p-2 text-center col-span-3">Falha ao buscar.</p>`;
                } finally { searchBtn.innerHTML = 'Buscar'; searchBtn.disabled = false; }
            };

            const handleFormatChange = (format) => {
                dom.controls.formatSelector.querySelectorAll('button').forEach(btn => { const isActive = btn.dataset.format === format; btn.classList.toggle('bg-cyan-600', isActive); btn.classList.toggle('text-white', isActive); btn.classList.toggle('bg-slate-700', !isActive); btn.classList.toggle('text-slate-300', !isActive); });
                const { container, containerWrapper } = dom.preview;
                container.classList.remove('aspect-video', 'aspect-square', 'aspect-portrait');
                containerWrapper.classList.remove('max-w-5xl', 'max-w-lg', 'max-w-sm');
                switch (format) {
                    case 'square': container.classList.add('aspect-square'); containerWrapper.classList.add('max-w-lg'); break;
                    case 'portrait': container.classList.add('aspect-portrait'); containerWrapper.classList.add('max-w-sm'); break;
                    default: container.classList.add('aspect-video'); containerWrapper.classList.add('max-w-5xl'); break;
                }
            };

             const addGraphic = (imageUrl, initialState = {}) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'graphic-element draggable';
                const img = document.createElement('img');
                img.src = imageUrl;
                img.crossOrigin = "anonymous";
                img.className = 'w-full h-full';
                const resizer = document.createElement('div');
                resizer.className = 'resizer bottom-right';
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '&times;';
                deleteBtn.className = 'delete-btn';
                deleteBtn.title = 'Excluir sticker';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    wrapper.remove();
                });

                wrapper.appendChild(img);
                wrapper.appendChild(resizer);
                wrapper.appendChild(deleteBtn);
                dom.preview.container.appendChild(wrapper);
                
                wrapper.style.width = initialState.width || '150px';
                wrapper.style.height = initialState.height || 'auto';
                wrapper.style.left = initialState.left || 'calc(50% - 75px)';
                wrapper.style.top = initialState.top || 'calc(50% - 50px)';
                wrapper.style.zIndex = initialState.zIndex || zIndexCounter++;
                
                makeDraggableAndResizable(wrapper);
                bringToFront(wrapper);
            };
            
            const handleGeneratePhrase = async () => {
                if (!selectedAdditionalText) {
                    alert("Selecione uma caixa de texto primeiro.");
                    return;
                }
                const btn = dom.controls.generatePhraseBtn;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loader"></span>';
                btn.disabled = true;

                const prompt = "You are an expert in music marketing. Generate a very short, high-impact call-to-action in English for a beat thumbnail. The goal is to make people click and listen or buy the beat. Be creative and use catchy language. Here are some styles to follow, pick one randomly: - Direct Call to Action: 'Listen Now', 'Buy This Beat', 'Link in Bio' - Benefit-Oriented: 'Your Next Hit', 'Studio Ready', 'Instant Inspiration' - Hype & Urgency: '🔥 NEW FIRE!', 'Don't Sleep On This', 'MUST HEAR 🔊' - Intriguing Question: 'Your Next #1?', 'Ready to Create?'. The final output should be just the phrase, without quotes or asterisks, and under 5 words.";
                
                try {
                    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                         throw new Error(`API Error: ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                        let text = result.candidates[0].content.parts[0].text;
                        text = text.replace(/["*]/g, '').trim();
                        dom.controls.additionalTextInput.value = text;
                        if(selectedAdditionalText) {
                            selectedAdditionalText.querySelector('h2').innerText = text;
                        }
                    } else {
                        throw new Error('Resposta da API inválida');
                    }
                } catch (error) {
                    console.error('Erro ao gerar frase com IA:', error);
                    alert('Falha ao gerar frase. Tente novamente.');
                } finally {
                    btn.innerHTML = 'Gerar Frase com IA';
                    btn.disabled = false;
                }
            };
            
            const loadAndApplyFont = (fontFamily) => {
                const fontId = 'dynamic-google-font';
                let link = document.getElementById(fontId);
                if (!link) {
                    link = document.createElement('link');
                    link.id = fontId;
                    link.rel = 'stylesheet';
                    document.head.appendChild(link);
                }
                link.href = `https://fonts.googleapis.com/css2?family=${fontFamily.replace(/ /g, '+')}&display=swap`;
                dom.preview.title.style.fontFamily = `'${fontFamily}', sans-serif`;
            };

            const displayFontResults = (fonts) => {
                const container = dom.controls.fontResultsContainer;
                container.innerHTML = '';
                fonts.slice(0, 50).forEach(font => {
                    const el = document.createElement('div');
                    el.className = 'font-item';
                    el.textContent = font.family;
                    el.style.fontFamily = `'${font.family}', sans-serif`; 
                    const fontLink = document.createElement('link');
                    fontLink.rel = 'stylesheet';
                    fontLink.href = `https://fonts.googleapis.com/css2?family=${font.family.replace(/ /g, '+')}&display=swap`;
                    document.head.appendChild(fontLink);
                    el.addEventListener('click', () => {
                        loadAndApplyFont(font.family);
                        dom.controls.fontSearchInput.value = font.family;
                        container.innerHTML = '';
                    });
                    container.appendChild(el);
                });
            };

            const fetchGoogleFonts = async () => {
                try {
                    const response = await fetch(`https://www.googleapis.com/webfonts/v1/webfonts?key=${GOOGLE_FONTS_API_KEY}`);
                    const data = await response.json();
                    googleFonts = data.items;
                    displayFontResults(googleFonts.slice(0, 10)); 
                } catch(e) {
                    console.error("Erro ao buscar fontes do Google:", e);
                    dom.controls.fontResultsContainer.innerHTML = `<p class="text-red-400 p-2 text-center">Erro ao carregar fontes.</p>`;
                }
            };

            const getPresets = () => JSON.parse(localStorage.getItem(PRESETS_STORAGE_KEY) || '{}');

            const populatePresetsDropdown = () => {
                const presets = getPresets();
                const select = dom.controls.loadPresetSelect;
                select.innerHTML = '';
                if (Object.keys(presets).length === 0) {
                    select.innerHTML = '<option disabled selected>Nenhum preset salvo</option>';
                    return;
                }
                for (const name in presets) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    select.appendChild(option);
                }
            };

            const getCurrentState = () => {
                const state = {};
                for (const key in dom.controls) {
                    const el = dom.controls[key];
                    if (el && typeof el.value !== 'undefined' && el.id) {
                         if (el.type === 'checkbox' || el.type === 'radio') { state[el.id] = el.checked; } else { state[el.id] = el.value; }
                    }
                }
                state.titleFontFamily = dom.preview.title.style.fontFamily; 
                state.elements = {};
                for(const key in dom.preview.wrappers) {
                    const el = dom.preview.wrappers[key];
                    state.elements[key] = { top: el.style.top, left: el.style.left, zIndex: el.style.zIndex };
                }
                 state.elements.logo = { top: dom.preview.logo.style.top, left: dom.preview.logo.style.left, zIndex: dom.preview.logo.style.zIndex, src: dom.preview.logo.src };
                state.stickers = [];
                document.querySelectorAll('.graphic-element').forEach(sticker => {
                    state.stickers.push({ src: sticker.querySelector('img').src, width: sticker.style.width, height: sticker.style.height, left: sticker.style.left, top: sticker.style.top, zIndex: sticker.style.zIndex });
                });
                return state;
            };
            
            const applyState = (state) => {
                document.querySelectorAll('.graphic-element').forEach(el => el.remove());
                for (const key in state) {
                    if (key === 'elements') {
                        for(const elKey in state.elements) {
                            const elState = state.elements[elKey];
                            const el = elKey === 'logo' ? dom.preview.logo : dom.preview.wrappers[elKey];
                            if(el) {
                                el.style.top = elState.top;
                                el.style.left = elState.left;
                                el.style.zIndex = elState.zIndex;
                                if(elKey === 'logo' && elState.src) { dom.preview.logo.src = elState.src; dom.preview.logo.style.display = 'block'; }
                            }
                        }
                    } else if (key === 'stickers') {
                        state.stickers.forEach(stickerState => addGraphic(stickerState.src, stickerState));
                    } else if (key === 'titleFontFamily' && state.titleFontFamily) {
                        loadAndApplyFont(state.titleFontFamily.split(',')[0].replace(/'/g, ''));
                    } else {
                        const el = dom.controls[Object.keys(dom.controls).find(k => dom.controls[k].id === key)];
                        if (el) {
                            if (el.type === 'checkbox' || el.type === 'radio') { el.checked = state[key]; } else { el.value = state[key]; }
                            if (el.tagName === 'SELECT') { el.dispatchEvent(new Event('change', { bubbles: true })); }
                        }
                    }
                }
                updatePreview();
            };
            
            const setupAccordion = () => {
                const panel = dom.controls.controlsPanel;
                panel.addEventListener('click', (e) => {
                    const legend = e.target.closest('.accordion-legend');
                    if (!legend) return;
                    const fieldset = legend.parentElement;
                    fieldset.classList.toggle('open');
                });
            };
            
            // --- NOVAS FUNÇÕES PARA TEXTO ADICIONAL ---
            const showTextEditorFor = (element) => {
                selectedAdditionalText = element;
                const textEl = element.querySelector('h2');
                dom.controls.additionalTextInput.value = textEl.innerText;
                dom.controls.additionalTextColor.value = rgbToHex(textEl.style.color);
                dom.controls.additionalTextSize.value = parseInt(textEl.style.fontSize);
                dom.controls.additionalTextEditor.classList.remove('hidden');
            };

            const hideTextEditor = () => {
                selectedAdditionalText = null;
                document.querySelectorAll('.additional-text-wrapper.selected').forEach(el => el.classList.remove('selected'));
                dom.controls.additionalTextEditor.classList.add('hidden');
            };

            const rgbToHex = (rgb) => {
                if (!rgb || !rgb.includes('rgb')) return '#ffffff';
                let [r, g, b] = rgb.match(/\d+/g).map(Number);
                return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
            };

            const addAdditionalText = () => {
                const id = `additional-text-${Date.now()}`;
                const wrapper = document.createElement('div');
                wrapper.id = id;
                wrapper.className = 'draggable additional-text-wrapper';

                const text = document.createElement('h2');
                text.className = 'preview-text-marketing text-center font-bold';
                text.innerText = 'NOVO TEXTO';
                text.style.color = '#FFFFFF';
                text.style.fontSize = '24px';
                
                wrapper.appendChild(text);
                dom.preview.container.appendChild(wrapper);

                wrapper.style.top = '20%';
                wrapper.style.left = '50%';
                wrapper.style.transform = 'translateX(-50%)';

                makeDraggableAndResizable(wrapper);
                bringToFront(wrapper);
                showTextEditorFor(wrapper);
            };
            
            const setupEventListeners = () => {
                // Eventos de input para todos os controles, exceto os dinâmicos
                for (const key in dom.controls) {
                    const el = dom.controls[key];
                    if (el && !['additionalTextEditor', 'additionalTextInput', 'additionalTextColor', 'additionalTextSize', 'deleteTextBtn', 'generatePhraseBtn', 'addTextBtn'].includes(key)) {
                        el.addEventListener('input', updatePreview);
                    }
                }

                dom.controls.addTextBtn.addEventListener('click', addAdditionalText);

                dom.controls.additionalTextInput.addEventListener('input', (e) => {
                    if (selectedAdditionalText) {
                        selectedAdditionalText.querySelector('h2').innerText = e.target.value;
                    }
                });
                dom.controls.additionalTextColor.addEventListener('input', (e) => {
                    if (selectedAdditionalText) {
                        selectedAdditionalText.querySelector('h2').style.color = e.target.value;
                    }
                });
                dom.controls.additionalTextSize.addEventListener('input', (e) => {
                    if (selectedAdditionalText) {
                        const size = e.target.value;
                        selectedAdditionalText.querySelector('h2').style.fontSize = `${size}px`;
                        dom.valueDisplays.additionalTextSize.textContent = `${size}px`;
                    }
                });
                dom.controls.deleteTextBtn.addEventListener('click', () => {
                    if(selectedAdditionalText) {
                        selectedAdditionalText.remove();
                        hideTextEditor();
                    }
                });

                // O resto dos listeners
                dom.controls.templateSelect.addEventListener('change', (e) => applyTemplate(e.target.value));
                dom.controls.backgroundUpload.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { const reader = new FileReader(); reader.onload = event => { dom.preview.bgImage.src = event.target.result; }; reader.readAsDataURL(e.target.files[0]); } });
                dom.controls.logoUpload.addEventListener('change', (e) => { if (e.target.files && e.target.files[0]) { const reader = new FileReader(); reader.onload = event => { dom.preview.logo.src = event.target.result; dom.preview.logo.style.display = 'block'; dom.preview.logo.style.top = '50%'; dom.preview.logo.style.left = '50%'; dom.preview.logo.style.transform = 'translate(-50%, -50%)'; }; reader.readAsDataURL(e.target.files[0]); } });
                
                makeDraggableAndResizable(dom.preview.logo);
                Object.values(dom.preview.wrappers).forEach(wrapper => makeDraggableAndResizable(wrapper));

                dom.controls.downloadBtn.addEventListener('click', handleDownload);
                dom.controls.imageSearchBtn.addEventListener('click', handleImageSearch);
                dom.controls.imageSearchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') { handleImageSearch(); } });
                dom.controls.stickerSearchBtn.addEventListener('click', handleStickerSearch);
                dom.controls.stickerSearchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') { handleStickerSearch(); } });
                
                dom.controls.stickerUpload.addEventListener('change', (e) => {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (event) => { addGraphic(event.target.result); };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });
                
                dom.controls.generatePhraseBtn.addEventListener('click', handleGeneratePhrase);

                dom.controls.formatSelector.addEventListener('click', (e) => { const target = e.target.closest('button'); if(target && target.dataset.format) { handleFormatChange(target.dataset.format); }});
                
                dom.controls.overlayType.addEventListener('change', (e) => {
                    const isSolid = e.target.value === 'solid';
                    dom.controls.solidColorControls.classList.toggle('hidden', !isSolid);
                    dom.controls.gradientControls.classList.toggle('hidden', isSolid);
                    updatePreview();
                });
                
                dom.controls.gridToggleBtn.addEventListener('click', () => {
                    const grid = dom.preview.alignmentGrid;
                    grid.classList.toggle('hidden');
                    dom.controls.gridToggleBtn.textContent = grid.classList.contains('hidden') ? 'Mostrar Grade' : 'Ocultar Grade';
                });

                dom.controls.titleFillType.addEventListener('change', (e) => {
                    const isSolid = e.target.value === 'solid';
                    dom.controls.titleSolidColorControls.classList.toggle('hidden', !isSolid);
                    dom.controls.titleGradientControls.classList.toggle('hidden', isSolid);
                    updatePreview();
                });

                dom.controls.savePresetBtn.addEventListener('click', () => {
                    const name = dom.controls.presetNameInput.value.trim();
                    if (!name) { alert('Por favor, dê um nome ao seu preset.'); return; }
                    const presets = getPresets();
                    presets[name] = getCurrentState();
                    localStorage.setItem(PRESETS_STORAGE_KEY, JSON.stringify(presets));
                    populatePresetsDropdown();
                    alert(`Preset "${name}" salvo!`);
                    dom.controls.presetNameInput.value = '';
                });

                 dom.controls.loadPresetBtn.addEventListener('click', () => {
                    const name = dom.controls.loadPresetSelect.value;
                    if (!name) return;
                    const presets = getPresets();
                    const state = presets[name];
                    if (state) { applyState(state); }
                });

                dom.controls.deletePresetBtn.addEventListener('click', () => {
                    const name = dom.controls.loadPresetSelect.value;
                    if (!name) return;
                    if (confirm(`Tem certeza que quer excluir o preset "${name}"?`)) {
                        const presets = getPresets();
                        delete presets[name];
                        localStorage.setItem(PRESETS_STORAGE_KEY, JSON.stringify(presets));
                        populatePresetsDropdown();
                    }
                });
                
                dom.controls.fontSearchInput.addEventListener('input', (e) => {
                     const searchTerm = e.target.value.toLowerCase();
                     const filteredFonts = googleFonts.filter(font => font.family.toLowerCase().includes(searchTerm));
                     displayFontResults(filteredFonts);
                });
            };

            const init = () => {
                dom.preview.wrappers.genre.style.zIndex = 20;
                dom.preview.wrappers.producer.style.zIndex = 21;
                dom.preview.wrappers.bpmKey.style.zIndex = 22;
                dom.preview.wrappers.title.style.zIndex = 23;
                dom.preview.logo.style.zIndex = 24;

                setupEventListeners();
                setupAccordion();
                fetchGoogleFonts();
                populatePresetsDropdown();
                applyTemplate('center');
                handleFormatChange('video');
                updatePreview();
            };
            
            init();
        });
    </script>
</body>
</html>
